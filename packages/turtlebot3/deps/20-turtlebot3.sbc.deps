#!/bin/bash

set -e

DEFAULT_INSTALL=true

CURRENT_DIR=$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")

#
# Install TurtleBot3 ROS 2 Packages
#
install_turtlebot3_ros2_packages()
{
  # Install Cartographer dependencies
  sudo apt-get update &&sudo apt-get install -y \
    google-mock \
    libceres-dev \
    liblua5.3-dev \
    libboost-dev \
    libboost-iostreams-dev \
    libprotobuf-dev \
    protobuf-compiler \
    libcairo2-dev \
    libpcl-dev \
    python3-sphinx

  # Install Gazebo9
  if [[ "$http_proxy" == "" ]];then
    curl -sSL http://get.gazebosim.org | sh
  else
    curl -sSL http://get.gazebosim.org|sed 's/apt-key adv --keyserver keyserver.ubuntu.com --recv-keys D2486D2DD83DB69272AFE98867170598AF24974/apt-key adv --keyserver keyserver.ubuntu.com --keyserver-options http-proxy=$http_proxy --recv-keys D2486D2DD83DB69272AFE98867170598AF24974/g'|sh
  fi
  sudo apt-get install -y ros-eloquent-gazebo-*

  #Install Cartographer
  sudo apt-get install -y ros-eloquent-cartographer

  # Install Navigation2
  # TODO: install navigation when packages are available for eloquent
  # sudo apt-get install -y ros-eloquent-navigation2
  # sudo apt-get install -y ros-eloquent-nav2-bringup

  # Install Navigation2 dependencies
  sudo apt-get update &&sudo apt-get install -y \
    libsdl1.2-dev \
    libsdl-image1.2-dev \
    ros-eloquent-test-msgs \
    libgraphicsmagick++1-dev

  # Install TurtleBot3
  # sudo apt-get install -y ros-eloquent-turtlebot3
  # sudo apt-get install -y ros-eloquent-turtlebot3-simulations
}

#
# Install udev rules
#
install_udev_rules()
{
  echo "Install udev rules for turtlebot3 ..."

  # Following commands show how to assign OpenCR port authorization to TurtleBot3.
  # Original file download from https://raw.githubusercontent.com/ROBOTIS-GIT/turtlebot3/ros2/turtlebot3_bringup/99-turtlebot3-cdc.rules
  if [ ! -f /etc/udev/rules.d/99-turtlebot3-cdc.rules ]; then
    sudo cp -rf "${CURRENT_DIR}"/99-turtlebot3-cdc.rules /etc/udev/rules.d/
  fi

  install_turtlebot3_deps
}

install_turtlebot3_deps()
{
  sudo udevadm control --reload-rules
  sudo udevadm trigger
}

release_package()
{
  echo "Install turtlebot3 sbc to rootfs"
  SOURCE_DIR=$1
  RELEASE_DIR=${2}
  ROOTFS="${RELEASE_DIR}"/rootfs

  sudo mkdir "$ROOTFS"/etc/udev/rules.d -p
  sudo cp -rf /etc/udev/rules.d/99-turtlebot3-cdc.rules "$ROOTFS"/etc/udev/rules.d/99-turtlebot3-cdc.rules
  
  # add install command to install.sh
  declare -f install_turtlebot3_deps >> "${RELEASE_DIR}/install.sh"
  echo "install_turtlebot3_deps" >> "${RELEASE_DIR}/install.sh"
}

#
# Main entry to build deps
#
function main()
{

  if [[ "$DEFAULT_INSTALL" != "true" ]]; then
    echo "Default not install, skip"
    exit
  fi

  TARGET_DIR=${1}
  RELEASE_OPT=${2}
  RELEASE_DIR=${3}

  if [ ! -d "${TARGET_DIR}" ]; then
    mkdir -p "${TARGET_DIR}"
    echo "No such directory, create \"${TARGET_DIR}\""
  fi

  # Install files to rootfs with --release
  if [[ "$RELEASE_OPT" == "--release" && "$RELEASE_DIR" != "" ]];then
    ROOTFS=${RELEASE_DIR}/rootfs
    release_package "${TARGET_DIR}" "${RELEASE_DIR}"
    exit
  fi

  install_udev_rules
  install_turtlebot3_ros2_packages
}

main "$@"
